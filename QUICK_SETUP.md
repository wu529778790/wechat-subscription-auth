# 快速配置指南 - 安全模式

## 📋 配置步骤（3分钟完成）

### 第1步：登录微信公众号后台

访问：https://mp.weixin.qq.com/

### 第2步：进入服务器配置页面

1. 左侧菜单 → **基本配置**
2. 找到 **服务器配置** 区域
3. 点击 **修改配置**

### 第3步：填写配置信息

在微信后台填写以下信息：

| 配置项 | 填写内容 | 复制按钮 |
|--------|----------|----------|
| **URL** | `https://your-domain.com/api/wechat/message` | 📋 复制 |
| **Token** | `[YOUR_WECHAT_TOKEN]` | 📋 复制 |
| **EncodingAESKey** | 点击"生成"按钮 | 📋 复制 |
| **消息加解密方式** | 选择 **安全模式** | ✅ 选择 |

### 第4步：获取 EncodingAESKey

在微信后台：
1. 点击 **EncodingAESKey** 旁边的 **"生成"** 按钮
2. 复制生成的43位字符

### 第5步：更新本地配置

将 EncodingAESKey 填入 `.env` 文件：

```bash
# 打开 .env 文件，找到这一行
WECHAT_AES_KEY=在这里粘贴微信生成的43位字符
```

**示例：**
```
WECHAT_AES_KEY=abcdefghijklmnopqrstuvwxyz1234567890ABC
```

### 第6步：重启应用

```bash
pnpm dev
```

### 第7步：点击"提交"

在微信后台点击 **"提交"** 按钮。

如果配置正确，会提示 **"配置成功"**！

---

## ✅ 验证配置

### 方法1：查看日志

重启后，你应该看到类似这样的日志：
```
[WeChat] 收到消息: <xml>...</xml>
[WeChat] 检测到加密消息，使用安全模式处理
[WeChat] 解密后消息: <xml>...</xml>
[WeChat] 使用安全模式回复（加密）
[WeChat] 加密回复生成成功
```

### 方法2：测试关注

1. 关注你的公众号
2. 应该自动收到欢迎消息 + 验证码
3. 发送"已关注"应该重新获取验证码

---

## 🔧 完整配置示例

你的 `.env` 文件应该是这样的：

```env
# ============================================
# 1. 网站配置
# ============================================
SITE_URL=https://your-domain.com
SESSION_SECRET=[YOUR_SESSION_SECRET]

# ============================================
# 2. 微信公众号配置
# ============================================
WECHAT_TOKEN=[YOUR_WECHAT_TOKEN]

# ============================================
# 3. 消息加解密配置（安全模式）
# ============================================
WECHAT_APPID=[YOUR_APP_ID]
WECHAT_APPSECRET=[YOUR_APP_SECRET]
WECHAT_AES_KEY=在这里粘贴微信生成的43位EncodingAESKey
```

---

## ❓ 常见问题

### Q: 提交时提示 "URL无法访问"

**检查：**
1. 服务器是否在运行？
2. 域名是否解析正确？
3. 防火墙是否开放443端口？
4. SSL证书是否有效？

### Q: 提示 "Token验证失败"

**检查：**
1. `.env` 中的 `WECHAT_TOKEN` 是否与微信后台完全一致
2. 重启应用使配置生效

### Q: 提示 "消息解密失败"

**检查：**
1. `.env` 中的 `WECHAT_AES_KEY` 是否正确（43位字符）
2. `.env` 中的 `WECHAT_APPID` 是否正确
3. 消息加解密方式是否选择了"安全模式"

---

## 📝 需要帮助？

查看详细文档：`SETUP_AESKEY.md`

或者直接问我！
