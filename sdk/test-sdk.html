<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SDK æµ‹è¯•é¡µé¢</title>
  <link rel="stylesheet" href="./wx-auth-simple.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .log { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    .btn { padding: 10px 20px; margin: 5px; cursor: pointer; background: #07C160; color: white; border: none; border-radius: 6px; }
    .btn:hover { background: #06AD56; }
    .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <h1>ğŸ” SDK æµ‹è¯•é¡µé¢</h1>

  <div>
    <h3>1. åˆå§‹åŒ– SDK</h3>
    <button class="btn" onclick="initSDK()">åˆå§‹åŒ– (http://localhost:3000)</button>
    <div id="init-log" class="log"></div>
  </div>

  <div>
    <h3>2. æµ‹è¯•éªŒè¯æµç¨‹</h3>
    <button class="btn" onclick="testAuth()" id="auth-btn" disabled>å¼€å§‹éªŒè¯</button>
    <div id="auth-status" class="status" style="display:none;"></div>
  </div>

  <div>
    <h3>3. æ£€æŸ¥ Cookie</h3>
    <button class="btn" onclick="checkCookie()">æ£€æŸ¥ Cookie</button>
    <div id="cookie-log" class="log"></div>
  </div>

  <div>
    <h3>4. æ‰‹åŠ¨æµ‹è¯• API</h3>
    <button class="btn" onclick="testAPI()">æµ‹è¯• /api/auth/check</button>
    <div id="api-log" class="log"></div>
  </div>

  <div>
    <h3>æ—¥å¿—è¾“å‡º</h3>
    <div id="console" class="log" style="min-height: 200px;"></div>
  </div>

  <script src="./wx-auth-simple.js"></script>
  <script>
    function log(msg) {
      const el = document.getElementById('console');
      el.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      el.scrollTop = el.scrollHeight;
      console.log('[TEST]', msg);
    }

    function initSDK() {
      const logEl = document.getElementById('init-log');
      try {
        WxAuth.init({
          apiBase: 'http://localhost:3000',
          onVerified: (user) => {
            log('âœ… onVerified å›è°ƒ: ' + JSON.stringify(user));
            showStatus('auth-status', 'success', 'éªŒè¯æˆåŠŸï¼ç”¨æˆ·: ' + (user.nickname || 'æœªçŸ¥'));
          },
          onError: (error) => {
            log('âŒ onError å›è°ƒ: ' + error);
            showStatus('auth-status', 'error', 'éªŒè¯å¤±è´¥: ' + error);
          }
        });
        logEl.textContent = 'âœ… SDK åˆå§‹åŒ–æˆåŠŸ';
        document.getElementById('auth-btn').disabled = false;
        log('SDK åˆå§‹åŒ–å®Œæˆ');
      } catch (e) {
        logEl.textContent = 'âŒ åˆå§‹åŒ–å¤±è´¥: ' + e.message;
        log('åˆå§‹åŒ–å¤±è´¥: ' + e.message);
      }
    }

    async function testAuth() {
      log('å¼€å§‹éªŒè¯æµç¨‹...');
      showStatus('auth-status', 'info', 'æ­£åœ¨å¯åŠ¨éªŒè¯...');

      try {
        const result = await WxAuth.requireAuth();
        log('requireAuth è¿”å›: ' + result);

        if (result) {
          log('âœ… éªŒè¯æˆåŠŸï¼ŒonVerified å·²è¢«è°ƒç”¨');
        } else {
          showStatus('auth-status', 'error', 'éªŒè¯è¢«å–æ¶ˆ');
          log('éªŒè¯è¢«å–æ¶ˆ');
        }
      } catch (e) {
        log('âŒ éªŒè¯å‡ºé”™: ' + e.message);
        showStatus('auth-status', 'error', 'å‡ºé”™: ' + e.message);
      }
    }

    function checkCookie() {
      const cookie = document.cookie;
      const wxCookie = cookie.split('; ').find(row => row.startsWith('wxauth-openid='));

      const logEl = document.getElementById('cookie-log');
      if (wxCookie) {
        const openid = wxCookie.split('=')[1];
        logEl.textContent = `âœ… æ‰¾åˆ° Cookie: ${wxCookie}`;
        log('Cookie æ£€æŸ¥: ' + wxCookie);
      } else {
        logEl.textContent = 'âŒ æœªæ‰¾åˆ° wxauth-openid Cookie';
        log('Cookie æ£€æŸ¥: æœªæ‰¾åˆ°');
      }
    }

    async function testAPI() {
      const logEl = document.getElementById('api-log');
      try {
        const response = await fetch('http://localhost:3000/api/auth/check');
        const data = await response.json();
        logEl.textContent = 'âœ… API å“åº”: ' + JSON.stringify(data);
        log('API æµ‹è¯•æˆåŠŸ: ' + JSON.stringify(data));
      } catch (e) {
        logEl.textContent = 'âŒ API æµ‹è¯•å¤±è´¥: ' + e.message;
        log('API æµ‹è¯•å¤±è´¥: ' + e.message);
      }
    }

    function showStatus(id, type, text) {
      const el = document.getElementById(id);
      el.style.display = 'block';
      el.className = 'status ' + type;
      el.textContent = text;
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('DOMContentLoaded', () => {
      log('é¡µé¢åŠ è½½å®Œæˆ');
      checkCookie();
    });
  </script>
</body>
</html>
